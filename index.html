<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dungeon</title>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body>
    <h1>The page is alive.</h1>

    <canvas id="game" width="640" height="480" style="border:2px solid red;"></canvas>

    <link rel="stylesheet" href="https://pyscript.net/unstable/pyscript.css" />
    <script defer src="https://pyscript.net/unstable/pyscript.js"></script>

    <py-script>
from js import document, setInterval
from pyodide.ffi import create_proxy

canvas = document.getElementById("game")
ctx = canvas.getContext("2d")

TILE = 32

dungeon = [
    "##########",
    "#........#",
    "#..##....#",
    "#........#",
    "##########"
]

x = TILE * 2
y = TILE * 2
speed = 3

keys = set()

def key_down(event):
    keys.add(event.key)

def key_up(event):
    keys.discard(event.key)

document.addEventListener("keydown", create_proxy(key_down))
document.addEventListener("keyup", create_proxy(key_up))

def is_wall(px, py):
    tile_x = int(px // TILE)
    tile_y = int(py // TILE)

    if tile_y < 0 or tile_y >= len(dungeon):
        return True
    if tile_x < 0 or tile_x >= len(dungeon[0]):
        return True

    return dungeon[tile_y][tile_x] == "#"

def draw_map():
    for row_i, row in enumerate(dungeon):
        for col_i, tile in enumerate(row):
            if tile == "#":
                ctx.fillStyle = "gray"
                ctx.fillRect(col_i * TILE, row_i * TILE, TILE, TILE)

def draw():
    global x, y

    new_x = x
    new_y = y

    if "w" in keys:
        new_y -= speed
    if "s" in keys:
        new_y += speed
    if "a" in keys:
        new_x -= speed
    if "d" in keys:
        new_x += speed

    # collision check
    if not is_wall(new_x, new_y):
        x = new_x
        y = new_y

    ctx.fillStyle = "black"
    ctx.fillRect(0, 0, canvas.width, canvas.height)

    draw_map()

    ctx.fillStyle = "gold"
    ctx.fillRect(x, y, 28, 28)

setInterval(create_proxy(draw), 16)

    </py-script>
</body>

</html>

