<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dungeon</title>

    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body>
    <h1>The page is alive.</h1>

    <canvas id="game" width="640" height="480" style="border:2px solid red;"></canvas>

    <py-script type="text/python">
from js import document, setInterval
from pyodide.ffi import create_proxy

canvas = document.getElementById("game")
ctx = canvas.getContext("2d")

TILE = 32
PLAYER_SIZE = 28
ENEMY_SIZE = 28

dungeon = [
    "#...################",
    "#..........#.......#",
    "#..........#.......#",
    "#...####..###..##..#",
    "#...#..............#",
    "#...#..............#",    
    "#...####.###########",
    "#...#.......#......#",
    "#...........#......#",
    "#...#.......#......#",
    "#...###########.####",    
    "#...................",
    "#...................",
    "#...................",    
    "####################"
]

# player
x = TILE * 2
y = TILE * 2
speed = 3
health = 5
invincible = 0  # mercy frames timer

# enemy
ex = TILE * 6
ey = TILE * 2
espeed = 2

keys = set()

def key_down(event):
    keys.add(event.key)

def key_up(event):
    keys.discard(event.key)

document.addEventListener("keydown", create_proxy(key_down))
document.addEventListener("keyup", create_proxy(key_up))

def is_wall(px, py):
    tile_x = int(px // TILE)
    tile_y = int(py // TILE)

    if tile_y < 0 or tile_y >= len(dungeon):
        return True
    if tile_x < 0 or tile_x >= len(dungeon[0]):
        return True

    return dungeon[tile_y][tile_x] == "#"

def hits_wall(px, py):
    corners = [
        (px, py),
        (px + PLAYER_SIZE - 1, py),
        (px, py + PLAYER_SIZE - 1),
        (px + PLAYER_SIZE - 1, py + PLAYER_SIZE - 1),
    ]

    for cx, cy in corners:
        if is_wall(cx, cy):
            return True
    return False

def rectangles_overlap(ax, ay, asize, bx, by, bsize):
    return (
        ax < bx + bsize and
        ax + asize > bx and
        ay < by + bsize and
        ay + asize > by
    )

def draw_map():
    for r, row in enumerate(dungeon):
        for c, tile in enumerate(row):
            if tile == "#":
                ctx.fillStyle = "gray"
                ctx.fillRect(c * TILE, r * TILE, TILE, TILE)

def move_enemy():
    global ex, ey

    dx = x - ex
    dy = y - ey

    nx, ny = ex, ey

    if abs(dx) > abs(dy):
        nx += espeed if dx > 0 else -espeed
        if is_wall(nx, ey):
            ny += espeed if dy > 0 else -espeed
    else:
        ny += espeed if dy > 0 else -espeed
        if is_wall(ex, ny):
            nx += espeed if dx > 0 else -espeed

    if not hits_wall(nx, ny):
        ex, ey = nx, ny

def draw():
    print("tick")
    global x, y, health, invincible

    new_x, new_y = x, y

    if "w" in keys:
        new_y -= speed
    if "s" in keys:
        new_y += speed
    if "a" in keys:
        new_x -= speed
    if "d" in keys:
        new_x += speed

    if not hits_wall(new_x, new_y):
        x, y = new_x, new_y

    move_enemy()

    # burn down mercy frames
    if invincible > 0:
        invincible -= 1

    # damage check
    if invincible == 0 and rectangles_overlap(x, y, PLAYER_SIZE, ex, ey, ENEMY_SIZE):
        health -= 1
        invincible = 30  # ~0.5 seconds at 60fps

    # death
    if health <= 0:
        health = 5
        x = TILE * 2
        y = TILE * 2
        invincible = 60

    ctx.fillStyle = "black"
    ctx.fillRect(0, 0, canvas.width, canvas.height)

    draw_map()

    # enemy
    ctx.fillStyle = "crimson"
    ctx.fillRect(ex, ey, ENEMY_SIZE, ENEMY_SIZE)

    # player (blink while invincible)
    if invincible % 10 < 5:
        ctx.fillStyle = "gold"
        ctx.fillRect(x, y, PLAYER_SIZE, PLAYER_SIZE)

    # UI
    ctx.fillStyle = "white"
    ctx.font = "16px monospace"
    ctx.fillText(f"HP: {health}", 10, 20)

draw_proxy = create_proxy(draw)
setInterval(draw_proxy, 16)

    </py-script>

</body>

</html>

